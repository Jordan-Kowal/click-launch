version: '3'

tasks:
  go:mod:tidy:
    summary: Runs `go mod tidy`
    internal: true
    cmds:
      - go mod tidy

  install:frontend:deps:
    summary: Install frontend dependencies
    sources:
      - package.json
      - bun.lock
    generates:
      - node_modules
    preconditions:
      - sh: bun --version
        msg: "bun is not installed. Install it: https://bun.sh"
    cmds:
      - bun install

  build:frontend:
    label: "build:frontend (DEV={{.DEV}})"
    summary: Build the frontend project
    sources:
      - "src/**/*"
      - "public/**/*"
      - package.json
      - vite.config.ts
      - tsconfig.json
      - tailwind.config.*
    generates:
      - dist/**/*
    deps:
      - task: install:frontend:deps
      - task: generate:bindings
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
    cmds:
      - bun run vite build
    env:
      PRODUCTION: '{{if eq .DEV "true"}}false{{else}}true{{end}}'

  generate:bindings:
    label: "generate:bindings (BUILD_FLAGS={{.BUILD_FLAGS}})"
    summary: Generates bindings for the frontend
    deps:
      - task: go:mod:tidy
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - bindings/**/*
    cmds:
      - wails3 generate bindings -f '{{.BUILD_FLAGS}}' -clean=true || echo "No bindings to generate (no services registered yet)"

  dev:frontend:
    summary: Runs the frontend in development mode
    deps:
      - task: install:frontend:deps
    cmds:
      - bun run vite --port {{.VITE_PORT}} --strictPort
